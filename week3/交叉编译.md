**Jni使用教程**

**下载android studio，随便找一个教程配置好安卓环境**

**android studio的Settings里面搜索sdk，进入Android SDK-》SDK Tools，勾选上NDK，应用，等待安装，将安装目录加入环境变脸（ndk-build所在的目录）。**

**新建一个项目，文件目录：**

![img](file:///C:/Users/Lenovo/AppData/Local/Temp/msohtmlclip1/01/clip_image002.jpg)

**先写一个java类（Mp3Encoder）**

![img](file:///C:/Users/Lenovo/AppData/Local/Temp/msohtmlclip1/01/clip_image004.jpg)

**在文件目录下运行javac -h . .\Mp3Encoder.java**

**第一个点代表生成.h文件在当前目录下。**

**新建jni文件夹位置，将.h文件（那个名字很长的）移动到那里（如目录图）**

**在jni文件夹里新建.cpp文件实现方法**

![img](file:///C:/Users/Lenovo/AppData/Local/Temp/msohtmlclip1/01/clip_image006.jpg)

**新建mk文件**

![img](file:///C:/Users/Lenovo/AppData/Local/Temp/msohtmlclip1/01/clip_image008.jpg)

**控制台运行ndk-build，会自动生成.so文件**

![img](file:///C:/Users/Lenovo/AppData/Local/Temp/msohtmlclip1/01/clip_image010.jpg)

**在build.gradle文件里，defaultConfig内加上**

![img](file:///C:/Users/Lenovo/AppData/Local/Temp/msohtmlclip1/01/clip_image012.jpg)

**在android内加上**

![img](file:///C:/Users/Lenovo/AppData/Local/Temp/msohtmlclip1/01/clip_image014.jpg)

**进入mainActivity，在构造函数前加上加载语句，就可以声明对象使用方法了**

![img](file:///C:/Users/Lenovo/AppData/Local/Temp/msohtmlclip1/01/clip_image016.jpg)

**我们愉快的可以在安卓java代码里调用c了，但是如何用react native实现有待进一步研究。目前了解关键词：JNI智能指针**

 

 

 

**Ffmpeg交叉编译**

在linux下进行编译较为方便（虚拟机）

运行以下脚本以完成对ffmpeg的makefile文件的生成和编译工作。

\#!/bin/bash

\# 以下路径需要修改成自己的NDK目录

TOOLCHAIN=/root/ff/android-ndk-r22/toolchains/llvm/prebuilt/linux-x86_64

\# 最低支持的android sdk版本

API=29

 

function build_android

{

\# 打印

echo "Compiling FFmpeg for $CPU"

\# 调用同级目录下的configure文件

./configure \

  --prefix=$PREFIX \

  --enable-neon \

  --enable-hwaccels \

  --enable-gpl \

  --disable-postproc \

  --enable-shared \

  --enable-jni \

  --enable-mediacodec \

  --enable-decoder=h264_mediacodec \

  --disable-static \

  --disable-doc \

  --disable-ffmpeg \

  --disable-ffplay \

  --disable-ffprobe \

  --disable-avdevice \

  --disable-doc \

  --disable-symver \

  --cross-prefix=$CROSS_PREFIX \

  --target-os=android \

  --arch=$ARCH \

  --cpu=$CPU \

  --cc=$CC \

  --cxx=$CXX \

  --enable-cross-compile \

  --sysroot=$SYSROOT \

  --extra-cflags="-Os -fpic $OPTIMIZE_CFLAGS" \

  --extra-ldflags="$ADDI_LDFLAGS" \

  $ADDITIONAL_CONFIGURE_FLAG

make clean

make -j16

make install

echo "The Compilation of FFmpeg for $CPU is completed"

}

 

\#armv8-a

ARCH=arm64

CPU=armv8-a

\# r21版本的ndk中所有的编译器都在/ndk/21.3.6528147/toolchains/llvm/prebuilt/darwin-x86_64/目录下（clang）

CC=$TOOLCHAIN/bin/aarch64-linux-android$API-clang

CXX=$TOOLCHAIN/bin/aarch64-linux-android$API-clang++

\# NDK头文件环境

SYSROOT=$TOOLCHAIN/sysroot

CROSS_PREFIX=$TOOLCHAIN/bin/aarch64-linux-android-

\# so输出路径

PREFIX=$(pwd)/android/$CPU

OPTIMIZE_CFLAGS="-march=$CPU"

build_android

 

\# 交叉编译工具目录,对应关系如下

\# armv8a -> arm64 -> aarch64-linux-android-

\# armv7a -> arm -> arm-linux-androideabi-

\# x86 -> x86 -> i686-linux-android-

\# x86_64 -> x86_64 -> x86_64-linux-android-

 

\# CPU架构

\#armv7-a

ARCH=arm

CPU=armv7-a

CC=$TOOLCHAIN/bin/armv7a-linux-androideabi$API-clang

CXX=$TOOLCHAIN/bin/armv7a-linux-androideabi$API-clang++

SYSROOT=$TOOLCHAIN/sysroot

CROSS_PREFIX=$TOOLCHAIN/bin/arm-linux-androideabi-

PREFIX=$(pwd)/android/$CPU

OPTIMIZE_CFLAGS="-mfloat-abi=softfp -mfpu=neon -marm -march=$CPU "

build_android

 

\#x86

ARCH=x86

CPU=x86

CC=$TOOLCHAIN/bin/i686-linux-android$API-clang

CXX=$TOOLCHAIN/bin/i686-linux-android$API-clang++

SYSROOT=$TOOLCHAIN/sysroot

CROSS_PREFIX=$TOOLCHAIN/bin/i686-linux-android-

PREFIX=$(pwd)/android/$CPU

OPTIMIZE_CFLAGS="-march=i686 -mtune=intel -mssse3 -mfpmath=sse -m32"

build_android

 

\#x86_64

ARCH=x86_64

CPU=x86-64

CC=$TOOLCHAIN/bin/x86_64-linux-android$API-clang

CXX=$TOOLCHAIN/bin/x86_64-linux-android$API-clang++

SYSROOT=$TOOLCHAIN/sysroot

CROSS_PREFIX=$TOOLCHAIN/bin/x86_64-linux-android-

PREFIX=$(pwd)/android/$CPU

OPTIMIZE_CFLAGS="-march=$CPU -msse4.2 -mpopcnt -m64 -mtune=intel"

\# 方法调用

build_android